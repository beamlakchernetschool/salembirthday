<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Quest</title>
    <!-- Tone.js for audio -->
    <script src="https://unpkg.com/tone@14.9.15/build/Tone.js"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&display=swap" rel="stylesheet">
    <style>
        /*
         * GLOBAL STYLES
         * Defines the overall look and feel of the game.
         * Using custom CSS variables for easy theming.
         */
        :root {
            --parchment-color: #f5f5dc;
            --border-color: #5d4037;
            --text-color: #3e2723;
            --button-bg: #8d6e63;
            --button-hover: #bcaaa4;
            --button-active: #a1887f;
            --inventory-bg: #e0d8bf;
            --toast-bg: #3e2723;
            --toast-text: #fff;
        }

        body {
            font-family: 'MedievalSharp', serif;
            background-color: #2c3e50; /* A dark, moody background */
            background-image: url('data:image/svg+xml;charset=UTF-8,<svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 100 100" preserveAspectRatio="none"><defs><pattern id="p" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M-1,1 l2,-2 M0,10 l10,-10 M9,11 l2,-2" stroke="rgba(255,255,255,0.05)" stroke-width="0.5"/></pattern></defs><rect width="100%" height="100%" fill="url(%23p)"/></svg>');
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            text-align: center;
            overflow: auto;
        }

        /*
         * GAME CONTAINER
         * The main wrapper for the game content.
         * Stylized to look like a thick, old book or scroll.
         */
        .game-container {
            width: 100%;
            max-width: 800px;
            background-color: var(--parchment-color);
            border: 15px solid var(--border-color);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6);
            padding: 30px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            gap: 25px;
            position: relative; /* For the toast container */
            transition: transform 0.3s ease-in-out;
        }

        .game-container:hover {
            transform: scale(1.005);
        }

        /*
         * HEADINGS
         */
        h1 {
            font-size: 2.8em;
            color: var(--border-color);
            text-shadow: 2px 2px 0 #fff;
            margin-bottom: 0;
            letter-spacing: 2px;
            line-height: 1.2;
        }
        
        /*
         * AVATAR
         */
        #avatar {
            width: 180px;
            height: 180px;
            border-radius: 50%;
            border: 6px solid var(--border-color);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
            object-fit: cover;
            align-self: center;
            animation: pulse 2s infinite ease-in-out;
            transition: all 0.3s ease-in-out;
        }

        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4); }
            50% { transform: scale(1.02); box-shadow: 0 8px 20px rgba(0, 0, 0, 0.6); }
            100% { transform: scale(1); box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4); }
        }

        /*
         * MAIN TEXT
         */
        #game-text {
            font-size: 1.3em;
            line-height: 1.6;
            text-align: justify;
            text-indent: 20px;
            background: rgba(255, 255, 255, 0.3);
            padding: 20px;
            border-radius: 10px;
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        /*
         * CHOICES / BUTTONS
         */
        #choices {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .choice-button {
            background: var(--button-bg);
            background: linear-gradient(145deg, var(--button-bg) 0%, #a1887f 100%);
            border: 3px solid var(--border-color);
            color: white;
            padding: 18px 25px;
            font-size: 1.2em;
            font-family: 'MedievalSharp', serif;
            cursor: pointer;
            border-radius: 12px;
            box-shadow: 0 6px 0 var(--border-color);
            transition: all 0.15s ease-in-out;
            text-align: center;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
            letter-spacing: 1px;
        }

        .choice-button:hover {
            background: linear-gradient(145deg, var(--button-hover) 0%, #bcaaa4 100%);
            transform: translateY(-3px);
            box-shadow: 0 9px 0 var(--border-color);
        }

        .choice-button:active {
            transform: translateY(3px);
            box-shadow: 0 3px 0 var(--border-color);
        }
        
        .choice-button.shake {
            animation: shake 0.5s;
            animation-iteration-count: 2;
        }
        
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            70% { transform: translate(3px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            90% { transform: translate(1px, 2px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }

        /*
         * INVENTORY
         */
        #inventory {
            background-color: var(--inventory-bg);
            border: 4px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            font-size: 1.1em;
            margin-top: 15px;
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        #inventory h3 {
            margin-top: 0;
            margin-bottom: 12px;
            color: var(--border-color);
            text-shadow: 1px 1px 0 #fff;
        }

        #inventory-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
        }

        #inventory-list li {
            background-color: var(--button-hover);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 8px 15px;
            color: white;
            font-size: 1em;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s ease-in-out;
        }
        
        #inventory-list li:hover {
            transform: scale(1.05);
        }
        
        /*
         * ENDING MODAL
         */
        .hidden {
            display: none !important;
        }

        .ending-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .ending-content {
            background-color: var(--parchment-color);
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.7);
            max-width: 600px;
            animation: fadeIn 2s ease-in-out, popIn 0.5s ease-out;
            border: 10px solid var(--border-color);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes popIn {
            0% { transform: scale(0.5); }
            80% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .ending-content h2 {
            font-size: 3em;
            color: var(--border-color);
            text-shadow: 2px 2px 0 #fff;
        }

        .ending-content p {
            font-size: 1.4em;
            line-height: 1.5;
            margin: 15px 0;
        }
        
        .ending-content .choice-button {
            margin-top: 20px;
            padding: 20px 40px;
            font-size: 1.5em;
        }

        /*
         * CAKE SPECIFIC STYLES
         */
        .cake-container {
            position: relative;
            cursor: pointer;
            width: 100%;
            max-width: 400px;
            margin: 0 auto 20px;
            transition: transform 0.5s ease-in-out;
        }

        .cake-container:hover {
            transform: scale(1.05);
        }

        .cake-svg-half {
            transform-origin: center bottom;
            transition: transform 0.5s ease-in-out;
        }
        
        .cake-half-left {
            transform: translateX(0);
        }

        .cake-half-right {
            transform: translateX(0);
        }
        
        .cake-split .cake-half-left {
            transform: translateX(-50%);
        }

        .cake-split .cake-half-right {
            transform: translateX(50%);
        }

        .middle-finger {
            position: absolute;
            font-size: 8em;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%) translateY(100%);
            transition: transform 0.5s ease-in-out, opacity 0.5s ease-in-out;
            opacity: 0;
        }

        .middle-finger.revealed {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        #tap-prompt {
            font-size: 1.2em;
            font-weight: bold;
            color: var(--border-color);
            animation: bounce 1s infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        
        /*
         * TOAST MESSAGES
         */
        #toast-container {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 1010;
        }

        .toast {
            background-color: var(--toast-bg);
            color: var(--toast-text);
            padding: 10px 20px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            opacity: 0;
            animation: toastFadeIn 0.5s forwards, toastFadeOut 0.5s 2.5s forwards;
            font-size: 1em;
            white-space: nowrap;
        }

        @keyframes toastFadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes toastFadeOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-20px); }
        }

        /*
         * MOBILE-FIRST ADJUSTMENTS
         */
        @media (max-width: 600px) {
            body {
                padding: 10px;
            }
            .game-container {
                padding: 20px;
                border-width: 10px;
                gap: 20px;
            }
            h1 {
                font-size: 2em;
            }
            #avatar {
                width: 120px;
                height: 120px;
                border-width: 4px;
            }
            #game-text {
                font-size: 1.1em;
                padding: 15px;
            }
            .choice-button {
                font-size: 1em;
                padding: 15px 20px;
            }
            #inventory {
                padding: 15px;
            }
            #toast-container {
                top: 10px;
            }
            .ending-content {
                padding: 20px;
                border-width: 5px;
            }
            .ending-content h2 {
                font-size: 2em;
            }
            .ending-content p {
                font-size: 1.1em;
            }
            .ending-content .choice-button {
                font-size: 1.2em;
                padding: 15px 30px;
            }
        }
    </style>
</head>
<body>

    <div class="game-container">
        <h1>A Quest for the Ages</h1>
        <img id="avatar" src="salem.png" alt="Character Avatar">
        <div id="game-text"></div>
        <div id="choices"></div>
        
        <div id="inventory">
            <h3>Inventory:</h3>
            <ul id="inventory-list"></ul>
        </div>
        <div id="toast-container"></div>
    </div>
    
    <div id="ending-modal" class="ending-modal hidden">
        <div class="ending-content">
            <h2 id="ending-title">Happy Birthday, Salem!</h2>
            <p id="ending-text">We've been waiting for you, you magnificent creature!</p>

            <!-- New cake container with two halves and a hidden message -->
            <div class="cake-container">
                <div class="middle-finger hidden">ðŸ–•</div>
                <svg id="cake-svg" viewBox="0 0 500 500" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <linearGradient id="icingGradient" x1="0" y1="0" x2="0" y2="1">
                            <stop offset="0%" stop-color="#fff"/>
                            <stop offset="100%" stop-color="#f0f0f0"/>
                        </linearGradient>
                        <linearGradient id="candleGradient" x1="0" y1="0" x2="0" y2="1">
                            <stop offset="0%" stop-color="#ffcc00"/>
                            <stop offset="100%" stop-color="#ff9900"/>
                        </linearGradient>
                    </defs>
                    <!-- Left Half -->
                    <g class="cake-svg-half cake-half-left">
                        <!-- Plate -->
                        <path d="M250,450 A200,40 0 0,0 100,450 L100,450 A150,50 0 0,0 250,450 Z" fill="#c0c0c0" stroke="#808080" stroke-width="5"/>
                        <!-- Cake Base -->
                        <path d="M100,200 A150,50 0 0,1 250,200 L250,450 A150,50 0 0,1 100,450 Z" fill="#ffb6c1" stroke="#a0a0a0" stroke-width="5"/>
                        <!-- Icing -->
                        <path d="M100,200 C150,180 200,220 250,200 L250,250 A150,50 0 0,0 100,250 Z" fill="url(#icingGradient)" stroke="#a0a0a0" stroke-width="5"/>
                        <!-- Candles -->
                        <rect x="150" y="100" width="10" height="80" fill="#5d4037" rx="3"/>
                        <rect x="245" y="110" width="5" height="80" fill="#5d4037" rx="3"/>
                        <!-- Flames -->
                        <path d="M155,100 C155,90 165,90 165,100 Z" fill="url(#candleGradient)" filter="url(#glow)"/>
                        <path d="M250,110 C250,100 255,100 255,110 Z" fill="url(#candleGradient)" filter="url(#glow)"/>
                        <!-- Decorations -->
                        <circle cx="155" cy="210" r="15" fill="#f44336" stroke="#fff" stroke-width="2"/>
                        <circle cx="250" cy="210" r="15" fill="#2196f3" stroke="#fff" stroke-width="2"/>
                    </g>
                    <!-- Right Half -->
                    <g class="cake-svg-half cake-half-right">
                        <!-- Plate -->
                        <path d="M250,450 A200,40 0 0,1 400,450 A150,50 0 0,1 250,450 Z" fill="#c0c0c0" stroke="#808080" stroke-width="5"/>
                        <!-- Cake Base -->
                        <path d="M250,200 A150,50 0 0,1 400,200 L400,450 A150,50 0 0,1 250,450 Z" fill="#ffb6c1" stroke="#a0a0a0" stroke-width="5"/>
                        <!-- Icing -->
                        <path d="M250,200 C300,180 350,220 400,200 L400,250 A150,50 0 0,0 250,250 Z" fill="url(#icingGradient)" stroke="#a0a0a0" stroke-width="5"/>
                        <!-- Candles -->
                        <rect x="340" y="100" width="10" height="80" fill="#5d4037" rx="3"/>
                        <!-- Flames -->
                        <path d="M345,100 C345,90 355,90 355,100 Z" fill="url(#candleGradient)" filter="url(#glow)"/>
                        <!-- Decorations -->
                        <circle cx="345" cy="210" r="15" fill="#4caf50" stroke="#fff" stroke-width="2"/>
                    </g>
                </svg>
            </div>
            <p id="tap-prompt">Tap the cake repeatedly!</p>
            <button class="choice-button" onclick="window.location.reload();">Play Again</button>
        </div>
    </div>

    <script>
        //
        // SCRIPT
        // This is the heart of the game, refactored into a GameManager object.
        // It handles state, scene rendering, and user interactions.
        //

        // === GameManager Object ===
        // This object encapsulates all the game logic, keeping the global scope clean.
        const GameManager = {
            // === Game State ===
            // The current state of the game, including scene, inventory, and secrets.
            gameState: {
                currentScene: 'audio_init',
                inventory: [],
                secrets: {
                    bowlingAnswered: false,
                    kidusAnswered: false,
                    gelgeloAnswered: false,
                    fikaduAnswered: false,
                },
                cakeTaps: 0, // NEW: Counter for cake taps
            },

            // === DOM Elements ===
            // Cache DOM elements for performance.
            dom: {},

            // === Game Assets ===
            // Centralized storage for avatars and item emojis.
            avatars: {
                salem: 'salem.png',
                beamlak: 'beamlak.png',
                kidus: 'kidus.png',
                gelgelo: 'gelgelo.png',
                amen: 'amen.png',
                fikadu: 'fikadu.png',
                dawit: 'dawig.png',
                unknown: 'unknown.png'
            },
            itemEmojis: {
                "Kidus's Hint": 'ðŸ“œ',
                "Holy Key": 'ðŸ”‘',
                "Magic Seed": 'ï¿½',
                "Bowling Key": 'ðŸŽ³',
                "Map": 'ðŸ—ºï¸',
                "Late Key": 'â³',
                "Sparks Tool": 'ðŸ”§'
            },

            // === Tone.js Audio Setup ===
            // Manage game music and sound effects.
            buttonClickSynth: null,
            preBirthdaySynth: null,
            preBirthdayPolySynth: null,
            preBirthdayBass: null,

            // Defines the game scenes and story content.
            scenes: {
                audio_init: {
                    text: "To begin your epic quest, you must first enable the sounds of the journey. Click the button below to start.",
                    avatar: 'salem',
                    choices: [
                        { text: "Start Quest (Enable Sound)", action: 'startAudioAndGame' }
                    ]
                },
                start: {
                    text: "The sun's golden rays pierce the window of your humble hut. A strange, gilded invitation lies on your bedside table. It reads: 'To the one born under the sign of the Leo, a grand treasure awaits. But first, you must prove your worth to those who hold the keys.'",
                    avatar: 'salem',
                    choices: [
                        { text: "Examine the invitation.", nextScene: 'read_note' }
                    ]
                },
                read_note: {
                    text: "The invitation is adorned with a strange symbolâ€”a bowling pin with a crown on top. It feels oddly familiar. You realize you must seek out your companions to find the treasure. But where to start? The village square awaits.",
                    avatar: 'salem',
                    choices: [
                        { text: "Go to the village square.", nextScene: 'village_square' }
                    ]
                },
                village_square: {
                    text: "You arrive in the bustling square. The air is filled with the scent of roasted meat and the chatter of merchants. You see your brother, Kidus, standing by the fountain, deep in thought. Near the market stalls, you spot your other companions: Gelgelo, Fikadu, Amen, and Beamlak. There's also Dawit, a quiet fellow tinkering with a battered lantern near the smith's cart.",
                    avatar: 'salem',
                    choices: [
                        { text: "Approach your brother, Kidus.", nextScene: 'meet_kidus' },
                        { text: "Go see Beamlak, your suspiciously weird friend.", nextScene: 'meet_beamlak' },
                        { text: "Find Gelgelo, the history enthusiast.", nextScene: 'meet_gelgelo' },
                        { text: "Look for Amen, the quiet one.", nextScene: 'meet_amen' },
                        { text: "Wait for Fikadu.", nextScene: 'wait_for_fikadu' },
                        { text: "Seek out Dawit, the quiet handyman.", nextScene: 'meet_dawit' },
                        { text: "Head towards the final door.", nextScene: 'final_door', condition: () => GameManager.gameState.inventory.includes("Holy Key") && GameManager.gameState.inventory.includes("Bowling Key") && GameManager.gameState.inventory.includes("Map") && GameManager.gameState.inventory.includes("Late Key") }
                    ]
                },
                meet_kidus: {
                    text: "Your brother, Kidus, looks up as you approach. He's humming a holy tune. 'Ah, little sister,' he says with a fun-loving sneer. 'I've been praying for a sign. A great riddle has been bestowed upon me. 'What is the name of the holy musical scale with seven tones?' Answer this, and the path to the 'Holy Tome' shall be revealed.'",
                    avatar: 'kidus',
                    choices: [
                        { text: "It's the Pentatonic scale.", nextScene: 'kidus_wrong_answer' },
                        { text: "It's the Diatonic scale.", nextScene: 'kidus_correct', condition: () => GameManager.gameState.inventory.includes("Map") },
                        { text: "I don't know.", nextScene: 'kidus_ask_around' }
                    ]
                },
                kidus_wrong_answer: {
                    text: "'Hahaha! No, you fool!' Kidus laughs, a mischievous glint in his eye. 'It's a sin to be so wrong! Go back and learn your scales, or you shall not pass!' he declares dramatically. He shoves a scroll in your hand that says: 'Gelgelo knows all'.",
                    avatar: 'kidus',
                    choices: [
                        { text: "Return to the village square.", nextScene: 'village_square' }
                    ],
                    onEnter: () => {
                         if (!GameManager.gameState.inventory.includes("Kidus's Hint")) {
                            GameManager.gameState.inventory.push("Kidus's Hint");
                        }
                    }
                },
                kidus_correct: {
                    text: "'Ah, the Diatonic scale! I see you've found wisdom, little sister,' Kidus says, his bullying smile turning into one of pride. He hands you a small, heavy book. Itâ€™s the 'Holy Tome,' and a golden key falls out as you open it. You now have the **Holy Key**.",
                    avatar: 'kidus',
                    choices: [
                        { text: "Take the Holy Key and return to the square.", nextScene: 'village_square' }
                    ],
                    onEnter: () => {
                        if (!GameManager.gameState.inventory.includes("Holy Key")) {
                            GameManager.gameState.inventory.push("Holy Key");
                            GameManager.gameState.secrets.kidusAnswered = true;
                        }
                    }
                },
                kidus_ask_around: {
                    text: "'You must seek the answer from a scholar,' Kidus says. 'Perhaps someone who babbles on about old things?'",
                    avatar: 'kidus',
                    choices: [
                        { text: "Return to the village square.", nextScene: 'village_square' }
                    ]
                },
                meet_beamlak: {
                    text: "You find Beamlak attempting to juggle three rotten apples. He fails spectacularly. 'Salem!' he exclaims, a wide, strange grin on his face. 'I've just done something incredible! I invented a cure for a fungal blight using a very *pathogenic* microbe, it's totally true! Would a *pathological* liar be able to do that? Anyway, I have a riddle for the next key. It's an ancient riddle: What is the source of all life? It's a small seed, but it holds the whole world within it.'",
                    avatar: 'beamlak',
                    choices: [
                        { text: "You're a pathological liar, that's what you are.", nextScene: 'beamlak_insulted' },
                        { text: "The Sun.", nextScene: 'beamlak_sun_wrong' },
                        { text: "A Magic Seed.", nextScene: 'beamlak_correct', condition: () => GameManager.gameState.inventory.includes("Magic Seed") }
                    ]
                },
                beamlak_insulted: {
                    text: "'Oof, right in the ego! You got me!' he says, wiping a tear from his eye. 'But I'll have you know, 'pathological' and 'pathogenic' are two different things. See, I'm not a total liar! Just a fun one.'",
                    avatar: 'beamlak',
                    choices: [
                        { text: "Return to the village square.", nextScene: 'village_square' }
                    ]
                },
                beamlak_sun_wrong: {
                    text: "'Ah, a good guess!' Beamlak says. 'The sun gives us light and warmth, but it's not the answer to this riddle. I want a small seed, not a giant star. Think about what's physically in the riddle!'",
                    avatar: 'beamlak',
                    choices: [
                        { text: "Return to the village square.", nextScene: 'village_square' }
                    ]
                },
                beamlak_correct: {
                    text: "Beamlak's eyes widen. 'You're right! A magical seed is the source of all life, even if it's a seed that can only be found with a hint from a friend!' He pulls a shiny silver key from his pocket. Itâ€™s the **Bowling Key**.",
                    avatar: 'beamlak',
                    choices: [
                        { text: "Take the Bowling Key and return to the square.", nextScene: 'village_square' }
                    ],
                    onEnter: () => {
                        if (!GameManager.gameState.inventory.includes("Bowling Key")) {
                            GameManager.gameState.inventory.push("Bowling Key");
                            GameManager.gameState.secrets.bowlingAnswered = true;
                        }
                    }
                },
                meet_gelgelo: {
                    text: "Gelgelo is giving an impassioned speech to a group of uninterested pigeons. '...and so, the ancient AASTU University was founded by the great Emperor Firaol the First in the year 1237! Its first scholars were pioneers in the field of Bio-Alchemy!' He looks up, sees you, and says, 'Ah, Salem! Are you here for a history lesson? Answer this: What year was the first AASTU University founded?'",
                    avatar: 'gelgelo',
                    choices: [
                        { text: "The year 1237.", nextScene: 'gelgelo_correct' },
                        { text: "The year 1345.", nextScene: 'gelgelo_wrong' },
                        { text: "I'll ask Kidus for a clue.", nextScene: 'gelgelo_ask_around' }
                    ]
                },
                gelgelo_correct: {
                    text: "'YES! The year 1237! A masterpiece of historical knowledge!' Gelgelo claps you on the back and hands you a scroll with an intricate map. 'This map shows the location of the **Hidden Garden**! Go forth, scholar!'",
                    avatar: 'gelgelo',
                    choices: [
                        { text: "Take the map and return to the square.", nextScene: 'village_square' }
                    ],
                    onEnter: () => {
                        if (!GameManager.gameState.inventory.includes("Map")) {
                            GameManager.gameState.inventory.push("Map");
                            GameManager.gameState.secrets.gelgeloAnswered = true;
                        }
                    }
                },
                gelgelo_wrong: {
                    text: "'Pah! You're hopeless! Go find a tome and read! The past is important!' he scoffs, and goes back to yelling at the pigeons.",
                    avatar: 'gelgelo',
                    choices: [
                        { text: "Return to the village square.", nextScene: 'village_square' }
                    ]
                },
                gelgelo_ask_around: {
                    text: "'He's just going to confuse you with his religious nonsense,' Gelgelo says. 'Just ask Amen, she's surprisingly helpful when she wants to be.'",
                    avatar: 'gelgelo',
                    choices: [
                        { text: "Return to the village square.", nextScene: 'village_square' }
                    ]
                },
                meet_amen: {
                    text: "Amen is sitting quietly on a bench, a small, beautiful flower in her hand. She offers it to you without a word. The flower has a single, perfect petal. As you take it, a tiny, glowing seed falls into your hand. You now have the **Magic Seed**.",
                    avatar: 'amen',
                    choices: [
                        { text: "Thank her and return to the square.", nextScene: 'village_square' }
                    ],
                    onEnter: () => {
                        if (!GameManager.gameState.inventory.includes("Magic Seed")) {
                            GameManager.gameState.inventory.push("Magic Seed");
                        }
                    }
                },
                wait_for_fikadu: {
                    text: "You wait. And wait. A grizzled old merchant walks by, sees you waiting, and chuckles. 'That one? He's as late as the spring harvest! He'll show up eventually, probably with a good excuse about an evil sorcerer or something.' As you are about to give up, you realize the spot where Fikadu was supposed to be has a strange, sacred mark. You recall your brother Kidus saying that a 'holy blessing is the key to all secrets.'",
                    avatar: 'fikadu',
                    choices: [
                        { text: "Try to find the key with your Holy Key.", nextScene: 'fikadu_correct', condition: () => GameManager.gameState.inventory.includes("Holy Key") },
                        { text: "Wait some more.", nextScene: 'fikadu_wrong' }
                    ]
                },
                fikadu_correct: {
                    text: "You take the Holy Key and press it against the mark on the ground. A bright light flashes, and the ground gives way, revealing a small box. Inside, you find a small, intricate key. The **Late Key**.",
                    avatar: 'fikadu',
                    choices: [
                        { text: "Take the Late Key and return to the square.", nextScene: 'village_square' }
                    ],
                    onEnter: () => {
                        if (!GameManager.gameState.inventory.includes("Late Key")) {
                            GameManager.gameState.inventory.push("Late Key");
                        }
                    }
                },
                fikadu_wrong: {
                    text: "You continue to wait. And wait. But nothing happens. It seems Fikadu is truly late this time.",
                    avatar: 'fikadu',
                    choices: [
                        { text: "Return to the village square.", nextScene: 'village_square' }
                    ]
                },
                meet_dawit: {
                    text: "Dawit works silently over a battered lantern, one hand steady as he tightens a brass screw. He doesn't speak much, but when he does it's in short, useful sentences. He peers up and says, 'You lookin' for tools? I keep things running. Take this â€” might help with stubborn locks or odd contraptions.' You gain a small, useful tool: the **Sparks Tool**.",
                    avatar: 'dawit',
                    choices: [
                        { text: "Take the Sparks Tool and return to the square.", nextScene: 'village_square' }
                    ],
                    onEnter: () => {
                        if (!GameManager.gameState.inventory.includes("Sparks Tool")) {
                            GameManager.gameState.inventory.push("Sparks Tool");
                        }
                    }
                },
                final_door: {
                    text: "The path leads to a large, ancient door, covered in intricate carvings. There are four keyholes: one shaped like a holy cross, one like a bowling pin, one like a map, and a final, simple one. You have all four keys.",
                    avatar: 'salem',
                    choices: [
                        { text: "Insert the keys and open the door.", nextScene: 'the_reveal', condition: () => GameManager.gameState.inventory.includes("Holy Key") && GameManager.gameState.inventory.includes("Bowling Key") && GameManager.gameState.inventory.includes("Map") && GameManager.gameState.inventory.includes("Late Key") }
                    ]
                },
                the_reveal: {
                    text: "The door creaks open to a dark room. You walk in cautiously. Suddenly, torches ignite, revealing a beautiful, large cake in the center of the room. Your friends, Beamlak, Kidus, Gelgelo, Amen, Fikadu, and Dawit, jump out from behind tapestries, yelling 'SURPRISE!'",
                    avatar: 'beamlak',
                    choices: [
                        { text: "Accept your destiny.", nextScene: 'ending' }
                    ]
                },
                ending: {
                    text: "They begin to sing, 'Happy birthday to you...' The music from the room transitions from the old tune to a familiar one. 'Happy birthday, dear Salem... Happy birthday to you!' It's your 69th birthday, after all.",
                    avatar: 'salem',
                    choices: [],
                    onEnter: () => {
                        GameManager.setupCakeInteraction();
                    }
                }
            },

            // === Tone.js Functions ===
            // Manages all the audio for the game.
            async setupAudio() {
                try {
                    await Tone.start();
                    this.buttonClickSynth = new Tone.Synth({
                        oscillator: { type: "square" },
                        envelope: { attack: 0.001, decay: 0.05, sustain: 0.0, release: 0.1 }
                    }).toDestination();
                    console.log("Audio context started successfully.");
                } catch (e) {
                    console.error("Audio failed to start:", e);
                }
            },

            startWholesomeMedievalMusic() {
                if (this.preBirthdaySynth) {
                    this.preBirthdaySynth.dispose();
                    this.preBirthdayPolySynth.dispose();
                    this.preBirthdayBass.dispose();
                    Tone.Transport.stop();
                    Tone.Transport.cancel();
                }

                // Main melody synth
                this.preBirthdaySynth = new Tone.Synth({
                    oscillator: { type: "sine" },
                    envelope: { attack: 0.02, decay: 0.5, sustain: 0.1, release: 0.5 }
                }).toDestination();
                
                // Polyphonic synth for chords
                this.preBirthdayPolySynth = new Tone.PolySynth(Tone.Synth, {
                    oscillator: { type: "triangle" },
                    envelope: { attack: 0.05, decay: 0.1, sustain: 0.3, release: 0.8 }
                }).toDestination();

                // Bass synth
                this.preBirthdayBass = new Tone.MonoSynth({
                    oscillator: { type: "sawtooth" },
                    envelope: { attack: 0.01, decay: 0.2, sustain: 0.5, release: 0.8 },
                    filter: { Q: 6, frequency: 500 }
                }).toDestination();

                // Define the musical sequences
                const melodyPart = new Tone.Sequence((time, note) => {
                    this.preBirthdaySynth.triggerAttackRelease(note, '8n', time);
                }, ["G4", "A4", "G4", "F#4", "E4", "C4", "D4", null], '4n');

                const chordsPart = new Tone.Sequence((time, chord) => {
                    this.preBirthdayPolySynth.triggerAttackRelease(chord, '2n', time);
                }, [
                    ["C4", "E4", "G4"],
                    ["G4", "B4", "D4"],
                    ["A4", "C5", "E5"],
                    ["F4", "A4", "C5"]
                ], '2n');

                const bassPart = new Tone.Sequence((time, note) => {
                    this.preBirthdayBass.triggerAttackRelease(note, '4n', time);
                }, ["C2", "G2", "A2", "F2"], '2n');

                // Start the parts and the transport
                melodyPart.start(0);
                chordsPart.start(0);
                bassPart.start(0);

                Tone.Transport.bpm.value = 100;
                Tone.Transport.loop = true;
                Tone.Transport.loopStart = 0;
                Tone.Transport.loopEnd = "4m";
                Tone.Transport.start();
            },
            
            stopMusic() {
                if (this.preBirthdaySynth) {
                    this.preBirthdaySynth.dispose();
                    this.preBirthdayPolySynth.dispose();
                    this.preBirthdayBass.dispose();
                }
                Tone.Transport.stop();
                Tone.Transport.cancel();
            },
            
            playBirthdaySong() {
                this.stopMusic();
                
                // Birthday Song notes (Happy Birthday)
                const notes = ["C4", "C4", "D4", "C4", "F4", "E4", "C4", "C4", "D4", "C4", "G4", "F4", "C4", "C4", "C5", "A4", "F4", "E4", "D4", "A#4", "A#4", "A4", "F4", "G4", "F4"];
                const durations = ["4n", "8n", "4n", "4n", "4n", "2n", "4n", "8n", "4n", "4n", "4n", "2n", "4n", "8n", "4n", "4n", "4n", "4n", "2n", "4n", "8n", "4n", "4n", "4n", "2n"];

                const birthdaySynth = new Tone.Synth().toDestination();
                
                let time = Tone.now();
                notes.forEach((note, index) => {
                    birthdaySynth.triggerAttackRelease(note, durations[index], time);
                    time += Tone.Time(durations[index]).toSeconds();
                });
            },
            
            // === Game Logic Functions ===
            // The main function to render a scene and update the UI.
            renderScene(sceneId) {
                const scene = this.scenes[sceneId];
                this.gameState.currentScene = sceneId;

                this.dom.gameTextEl.textContent = scene.text;
                this.dom.avatarEl.src = this.avatars[scene.avatar] || this.avatars.unknown;
                
                this.dom.choicesEl.innerHTML = '';

                scene.choices.forEach(choice => {
                    if (choice.condition && !choice.condition()) {
                        return;
                    }

                    const button = document.createElement('button');
                    button.className = 'choice-button';
                    button.textContent = choice.text;
                    button.onclick = () => {
                        if (this.buttonClickSynth) {
                            // play a soft, short sound
                            this.buttonClickSynth.triggerAttackRelease("C4", "16n");
                        }
                        if (choice.action) {
                            GameManager[choice.action]();
                        } else {
                            GameManager.handleChoice(choice);
                        }
                    };
                    this.dom.choicesEl.appendChild(button);
                });

                const oldInventoryCount = this.gameState.inventory.length;
                if (scene.onEnter) {
                    scene.onEnter();
                }
                if (this.gameState.inventory.length > oldInventoryCount) {
                    const newItem = this.gameState.inventory[this.gameState.inventory.length - 1];
                    this.showToast(`New item acquired: ${this.itemEmojis[newItem]} ${newItem}`);
                }

                this.updateInventory();
                this.handleEndingModal(sceneId);
            },
            handleChoice(choice) {
                if (choice.nextScene) {
                    this.renderScene(choice.nextScene);
                }
            },
            updateInventory() {
                this.dom.inventoryListEl.innerHTML = '';
                if (this.gameState.inventory.length === 0) {
                    const li = document.createElement('li');
                    li.textContent = "Empty";
                    this.dom.inventoryListEl.appendChild(li);
                } else {
                    this.gameState.inventory.forEach(item => {
                        const li = document.createElement('li');
                        li.innerHTML = `${this.itemEmojis[item] || ''} ${item}`;
                        this.dom.inventoryListEl.appendChild(li);
                    });
                }
            },
            showToast(message) {
                const toastEl = document.createElement('div');
                toastEl.className = 'toast';
                toastEl.textContent = message;
                this.dom.toastContainerEl.appendChild(toastEl);

                setTimeout(() => {
                    toastEl.remove();
                }, 3000); // 3-second display time
            },
            handleEndingModal(sceneId) {
                if (sceneId === 'ending') {
                    this.dom.endingModalEl.classList.remove('hidden');
                    this.playBirthdaySong();
                } else {
                    this.dom.endingModalEl.classList.add('hidden');
                }
            },
            
            // New function to handle the cake interaction at the end
            setupCakeInteraction() {
                this.dom.endingTitleEl.textContent = "Tap the cake repeatedly!";
                this.dom.endingTextEl.textContent = "It's not over yet...";
                this.dom.cakeContainerEl.addEventListener('click', this.handleCakeTap);
                this.dom.cakeContainerEl.addEventListener('touchstart', this.handleCakeTap);
                this.gameState.cakeTaps = 0; // Reset taps for the new game session
            },

            handleCakeTap(event) {
                GameManager.gameState.cakeTaps++;
                GameManager.dom.tapPromptEl.textContent = `Taps: ${GameManager.gameState.cakeTaps}/10`;
                
                if (GameManager.gameState.cakeTaps >= 10) {
                    // Remove the event listeners after the prank is triggered
                    GameManager.dom.cakeContainerEl.removeEventListener('click', GameManager.handleCakeTap);
                    GameManager.dom.cakeContainerEl.removeEventListener('touchstart', GameManager.handleCakeTap);

                    // Trigger the cake splitting animation
                    GameManager.dom.cakeContainerEl.classList.add('cake-split');
                    GameManager.dom.middleFingerEl.classList.remove('hidden');
                    GameManager.dom.middleFingerEl.classList.add('revealed');

                    // Play a special sound effect
                    if (GameManager.buttonClickSynth) {
                         GameManager.buttonClickSynth.triggerAttackRelease("C5", "8n");
                    }

                    // Update the final ending text
                    GameManager.dom.endingTitleEl.textContent = "GOTCHA!";
                    GameManager.dom.endingTextEl.textContent = "Happy Birthday, you magnificent troll!";
                }
            },
            
            // This function is called by the "Start Quest" button
            async startAudioAndGame() {
                try {
                    await this.setupAudio();
                    this.startWholesomeMedievalMusic(); // Changed to the new music function
                    this.renderScene('start');
                } catch (e) {
                    console.error("Audio failed to start:", e);
                    // Fallback: render the game without audio
                    this.renderScene('start');
                }
            },
            
            // === Initialization ===
            // This is the starting point for the whole game.
            init() {
                // Get all necessary DOM elements
                this.dom.gameTextEl = document.getElementById('game-text');
                this.dom.choicesEl = document.getElementById('choices');
                this.dom.avatarEl = document.getElementById('avatar');
                this.dom.inventoryListEl = document.getElementById('inventory-list');
                this.dom.endingModalEl = document.getElementById('ending-modal');
                this.dom.toastContainerEl = document.getElementById('toast-container');
                
                // NEW: Get the elements for the ending prank
                this.dom.endingTitleEl = document.getElementById('ending-title');
                this.dom.endingTextEl = document.getElementById('ending-text');
                this.dom.cakeContainerEl = document.querySelector('.cake-container');
                this.dom.middleFingerEl = document.querySelector('.middle-finger');
                this.dom.tapPromptEl = document.getElementById('tap-prompt');

                // Bind the event handler to the GameManager object
                this.handleCakeTap = this.handleCakeTap.bind(this);
                
                // Start the game by rendering the first scene.
                this.renderScene(this.gameState.currentScene);
            }
        };

        // Start the game when the DOM is fully loaded.
        document.addEventListener('DOMContentLoaded', () => {
            GameManager.init();
        });
    </script>
</body>
</html>
ï¿½
